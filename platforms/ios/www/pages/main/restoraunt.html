<template>

    <div class="page no-swipeback">

        <div class="navbar navbar-large">

            <div class="navbar-bg"></div>

            <div class="navbar-inner">

                <div class="left">

                    <a href="#" class="back link">

                        <i class="icon icon-back"></i>

                        <span>Назад</span>

                    </a>

                </div>

                <div class="title">

                    {{#if restoraunt}}

                        {{restoraunt.name}}

                    {{else}}

                        {{#if showSkeleton}}

                            <div class="skeleton-block" style="width: 100px;"></div>

                        {{/if}}

                    {{/if}}

                </div>

                <div class="title-large">

                    <div class="title-large-text">

                        {{#if restoraunt}}

                            {{restoraunt.name}}

                        {{else}}

                            {{#if showSkeleton}}

                                <div class="skeleton-block" style="width: 190px;"></div>

                            {{/if}}

                        {{/if}}

                    </div>

                </div>

                <div class="right">

                    <a class="link icon-only searchbar-enable" data-searchbar=".searchbar-items">

                        <i class="icon f7-icons">search</i>

                    </a>

                    <a href="#" class="link favorite-button">

                        <i class="icon f7-icons">bookmark</i>

                    </a>

                </div>

                <form class="searchbar searchbar-items searchbar-expandable">

                    <div class="searchbar-inner">

                        <div class="searchbar-input-wrap">

                            <input type="search" placeholder="Введите название блюда..."/>

                            <i class="searchbar-icon"></i>

                            <span class="input-clear-button"></span>

                        </div>

                        <span class="searchbar-disable-button">Отмена</span>

                    </div>

                </form>

                {{#js_if "this.restoraunt && this.restoraunt.categories.length > 1"}}

                <div class="subnavbar searchbar-hide-on-enable">

                    <div class="subnavbar-inner categories padding-horizontal">

                        {{#each restoraunt.categories}}

                            <button class="button button-round bg-color-light-gray color-black button-large button-outline" data-id="{{id}}">{{name}}</button>

                        {{/each}}

                    </div>

                </div>

                {{/js_if}}

            </div>

        </div>

        <div class="page-content">

            {{#if restoraunt}}

                <div class="padding block-info searchbar-hide-on-enable">

                    {{#js_if "this.restoraunt.reviews_count >= app.params.config.min_reviews_count_for_show_rating"}}

                    <button @click="openReviews" class="button button-round button-outline width-auto margin-bottom color-black display-inline-block button-small sheet-open-" data-sheet=".sheet-rating">

                        <i class="icon f7-icons text-color-orange">star_fill</i>

                        <span>{{js "this.restoraunt.rating.toFixed(1)"}} ({{restoraunt.reviews_count}})</span>

                    </button>

                    {{/js_if}}

                    <div class="sheet-modal sheet-rating sheet-template-1" data-swipe-to-close="true" data-backdrop="true">

                        <div class="sheet-modal-inner">

                            <div class="swipe-handler"></div>

                            <div class="block">

                                <div class="block-title block-title-large">Рейтинг {{js "this.restoraunt.rating.toFixed(1)"}} <i class="icon f7-icons text-color-orange">star_fill</i></div>

                            </div>

                            <button class="button button-large bg-color-light-gray color-black button-ok sheet-close">Хорошо</button>

                        </div>

                    </div>

                    <button class="button button-round button-outline width-auto margin-bottom color-black display-inline-block button-small sheet-open" data-sheet=".sheet-delivery-time">

                        <i class="icon f7-icons">alarm</i>

                        <span>{{restoraunt.delivery_time}} мин</span>

                    </button>

                    <div class="sheet-modal sheet-delivery-time sheet-template-1" data-swipe-to-close="true" data-backdrop="true">

                        <div class="sheet-modal-inner">

                            <div class="swipe-handler"></div>

                            <div class="block">

                                <div class="block-title block-title-medium text-align-center">Заказ доставит ресторан</div>

                                <div class="margin text-color-gray text-align-center">Время доставки {{restoraunt.delivery_time}} мин, качество доставки контролирует ресторан.</div>

                            </div>

                            <button class="button button-large bg-color-light-gray color-black button-ok sheet-close">Хорошо</button>

                        </div>

                    </div>

                    <button class="button button-round button-outline width-auto margin-bottom color-black display-inline-block button-small sheet-open" data-sheet=".sheet-min-order-sum">

                        <i class="icon f7-icons">money_rubl_circle</i>

                        <span>Заказ от {{restoraunt.min_order_sum}} ₽</span>

                    </button>

                    <div class="sheet-modal sheet-min-order-sum sheet-template-1" data-swipe-to-close="true" data-backdrop="true">

                        <div class="sheet-modal-inner">

                            <div class="swipe-handler"></div>

                            <div class="block">

                                <div class="block-title block-title-medium text-align-center">Минимальная сумма заказа</div>

                                <div class="margin text-color-gray text-align-center">Для оформления заказа сумма должна составлять {{restoraunt.min_order_sum}} ₽</div>

                            </div>

                            <button class="button button-large bg-color-light-gray color-black button-ok sheet-close">Хорошо</button>

                        </div>

                    </div>

                    {{#js_if "Number(this.restoraunt.free_delivery_sum) > 0"}}

                    <button class="button button-round button-outline width-auto margin-bottom color-black display-inline-block button-small sheet-open" data-sheet=".sheet-delivery">

                        <span>Доставка 0-{{restoraunt.delivery_price}} ₽</span>

                    </button>

                    <div class="sheet-modal sheet-delivery sheet-template-1" data-swipe-to-close="true" data-backdrop="true">

                        <div class="sheet-modal-inner">

                            <div class="swipe-handler"></div>

                            <div class="block">

                                <div class="block-title block-title-medium text-align-center">Доставка</div>

                                <div class="list">

                                    <ul>

                                        <li class="item-content">

                                            <div class="item-inner">

                                                <div class="item-title">Заказ до {{restoraunt.free_delivery_sum}} ₽</div>

                                                <div class="item-after">{{restoraunt.delivery_price}} ₽</div>

                                            </div>

                                        </li>

                                        <li class="item-content">

                                            <div class="item-inner">

                                                <div class="item-title">Заказ от {{restoraunt.free_delivery_sum}} ₽</div>

                                                <div class="item-after">Бесплатно</div>

                                            </div>

                                        </li>

                                    </ul>

                                </div>

                            </div>

                            <button class="button button-large bg-color-light-gray color-black button-ok sheet-close">Хорошо</button>

                        </div>

                    </div>

                    {{/js_if}}

                    {{#js_if "this.restoraunt.stocks.length > 0"}}

                        <div class="block-title no-margin-top no-margin-horizontal">Акции</div>

                        <div class="display-flex stocks">

                            {{#each restoraunt.stocks}}

                                <div class="margin-right stock width-auto text-color-black sheet-open border-color-primary" data-sheet=".sheet-stock-{{id}}">

                                    <div class="stock-inner">

                                        <div class="stock-name">{{#js_if "this.name.length > 100"}}{{js "this.name.substring(0, 100)"}}...{{else}}{{js "this.name"}}{{/js_if}}</div>

                                    </div>

                                </div>

                                <div class="sheet-modal sheet-stock-{{id}} sheet-template-1" data-swipe-to-close="true" data-backdrop="true">

                                    <div class="sheet-modal-inner">

                                        <div class="swipe-handler"></div>

                                        <div class="block">

                                            <div class="block-title block-title-medium text-align-center">Акция</div>

                                            <div class="margin text-color-gray text-align-center">{{name}}</div>

                                        </div>

                                        <button class="button button-large bg-color-light-gray color-black button-ok sheet-close">Хорошо</button>

                                    </div>

                                </div>

                            {{/each}}

                        </div>

                    {{/js_if}}

                </div>

                {{#js_if "this.restoraunt.categories.length > 1"}}

                <div class="searchbar-hide-on-enable">

                    <div class="margin display-flex categories">

                        {{#each restoraunt.categories}}

                            <button class="button button-round bg-color-light-gray color-black button-large button-outline" data-id="{{id}}">{{name}}</button>

                        {{/each}}

                    </div>

                </div>

                {{/js_if}}

                <div class="searchbar-not-found margin">По вашему запросу ничего не найдено.</div>

                <div class="block-items-1">

                    {{#each restoraunt.categories}}

                        <div class="block-items">

                            <div class="block-title block-title-medium category-title" data-id="{{id}}">{{name}}</div>

                            <div class="row items margin" data-id="{{id}}">

                                {{#each items}}

                                    <div @click="openItem('{{../id}}', '{{id}}')" class="item large-25 col-50 margin-bottom bg-color-white">

                                        {{#if image_thumb_512}}

                                            <div class="item-image {{#js_if "app.device.ios"}}lazy lazy-fade-in{{/js_if}}" {{#js_if "app.device.ios"}}data-background="{{image_thumb_512}}"{{else}}style="background-image: url('{{image_thumb_512}}')"{{/js_if}}></div>

                                        {{/if}}

                                        <div class="item-info margin">

                                            <div class="item-title margin-bottom">{{name}}</div>

                                            <div class="row">

                                                <div class="col-50 item-price">{{price}} ₽</div>

                                                <div class="col-50 text-align-right item-weight text-color-gray">{{weight}}</div>

                                            </div>

                                        </div>

                                    </div>

                                {{/each}}

                            </div>

                        </div>

                    {{/each}}

                </div>

            {{else}}

                {{#if showSkeleton}}

                    <div class="skeleton-effect-blink">

                        <div class="margin display-flex categories">

                            {{#each '123456789'}}

                                <div class="skeleton-block button-round button" style="width: 130px; height: 44px;"></div>

                            {{/each}}

                        </div>

                        <div class="block-title block-title-medium category-title skeleton-text">_____________</div>

                        <div class="row items margin">

                            {{#each '123456789'}}

                                <div class="item large-25 col-50 margin-bottom bg-color-white skeleton-text">
    0
                                    <div class="skeleton-block" style="width: 100%; height: 100px;"></div>

                                    <div class="item-info margin">

                                        <div class="item-title margin-bottom">____ _____</div>

                                        <div class="row">

                                            <div class="col-50 item-price">____</div>

                                            <div class="col-50 text-align-right item-weight text-color-gray">____</div>

                                        </div>

                                    </div>

                                </div>

                            {{/each}}

                        </div>

                    </div>

                {{/if}}

            {{/if}}

        </div>

    </div>

</template>

<style scoped>

    {{this}} {
        background: #F5F5F5;
    }

    {{this}} .navbar-hidden * {
        opacity: 0 !important;
    }

    {{this}} .page-content {
        --f7-page-navbar-offset: calc(var(--f7-navbar-height) + var(--f7-navbar-large-title-height) + var(--f7-safe-area-top));
        padding-bottom: 150px;
    }

    {{this}} .block-info::-webkit-scrollbar {
        display: none;
    }

    {{this}} .block-info *::-webkit-scrollbar {
                 display: none;
             }

    {{this}} .block-info .icon {
                 font-size: 16px;
                 line-height: 12px;
             }

    {{this}} .block-info {
                 background: #f9f9f9;
                 border-radius: 0px 0px 30px 30px
             }


    {{this}} .block-info .button:not(.stock) {
                 margin-right: 5px;
                 font-size: 12px;
                 text-transform: none
             }

    {{this}} .navbar .navbar-bg::after {
                 display: none;
             }

    {{this}} .categories {
                 overflow: auto;
             }

    {{this}} .categories .button {
                 width: auto;
                 flex-shrink: 0;
                 margin-right: 10px;
                 text-transform: none;
                 font-weight: 600;
        --f7-button-padding-horizontal: 30px;
             }

    {{this}} .items {

             }

    {{this}} .items .item {
                 border-radius: 10px;
                 overflow: hidden;
                 border: 2px solid #EEEEEE;
             }

    {{this}} .items .item .item-image {
                 height: 140px;
                 background-repeat: no-repeat;
                 background-position: center;
                 background-size: cover;
                 background-color: #E0E0E0;
             }

    {{this}} .items .item .item-info {

             }

    {{this}} .items .item .item-title {
                 font-size: 16px;
                 font-weight: 300;
             }

    {{this}} .items .item .item-price {
                 font-size: 16px;
                 font-weight: bold;
             }

    {{this}} .items .item .item-weight {

             }

    {{this}} {
        --f7-subnavbar-height: 60px;
    }

    {{this}} .subnavbar {
                 background: none !important;
                 backdrop-filter: none;
                 display: none;
        transition: .3s;
             }

    {{this}} .navbar.subnavbar-show .navbar-bg {
                 height: calc(100% + var(--f7-navbar-large-title-height) + var(--f7-subnavbar-height));
             }

    {{this}} .navbar.subnavbar-show .subnavbar {
                 display: block;
             }

    {{this}} .stocks {
                 overflow: auto;
             }

    {{this}} .stocks .stock {
                 flex-shrink: 0;
                 height: auto;
                 line-height: 15px;
                 border-radius: 10px;
                 max-width: 250px;
                 font-weight: 600;
                 position: relative;
                 font-size: 14px;
                 border-style: dashed;
                 border-width: 2px;
                 padding: 10px 10px;
             }

    {{this}} .stocks .stock .stock-inner {
                 display: table;
                 height: 100%;
             }

    {{this}} .stocks .stock .stock-inner .stock-name {
                 display: table-cell;
                 vertical-align: middle;
             }

    @media only screen and (max-device-width: 320px) {

        {{this}} .categories .button {
                 font-weight: 600;
                 --f7-button-padding-horizontal: 15px;
                 font-size: 12px;
                 --f7-button-height: 30px;
                 margin-right: 5px;
        }

        {{this}} .items .item .item-title {
                 font-size: 14px;
        }

        {{this}} .items .item .item-price {
                 font-size: 14px;
        }

    }


</style>

<script>

    return {

        data: function () {

            return {


            }

        },
        methods: {
            openReviews: function () {

                let component = this;
                let page = component.$el;

                app.views.current.router.navigate('/main/reviews', {
                    context: {
                        restoraunt: component.restoraunt
                    }
                });

            },
            openItem: function (categoryId, itemId) {

                let component = this;
                let page = component.$el;

                let category = component.restoraunt.categories.find(function (category) {

                    return category.id == categoryId;

                });

                let item = category.items.find(function (item) {

                    return item.id == itemId;

                });

                let image = item.image ? '<div class="item-image" style="background-image: url(' + item.image_thumb + ')"><div class="overlay"></div></div>' : '';

                if (item.weight.length > 0 && item.sostav.length > 0 && item.sostav.indexOf(' • ') == -1) {

                    item.sostav = ' • ' + item.sostav;

                }

                let sheet = app.sheet.create({
                    content: `

                        <div class="sheet-modal sheet-item sheet-template-1">

                            <div class="sheet-modal-inner">

                                ` + image + `

                                <div class="margin-horizontal item-info margin-bottom">

                                    <div class="item-title">` + item.name + `</div>

                                    <div class="item-desc margin-top text-color-gray">` + item.weight + item.sostav + `</div>

                                    <div class="row add-to-cart">

                                        <div class="col-50">

                                          <div class="stepper stepper-fill width-100 stepper-large color-black stepper-round">

                                            <div class="stepper-button stepper-button-minus disabled sound-2 vibrate" data-vibrateTime="30"></div>

                                            <div class="stepper-input-wrap">

                                              <input type="text" class="text-color-black" value="1" min="1" max="100" step="1" readonly>

                                            </div>

                                            <div class="stepper-button stepper-button-plus sound-1 vibrate" data-vibrateTime="30"></div>

                                          </div>

                                        </div>

                                        <div class="col-50">

                                            <button data-item="` + item.id + `" data-category="` + categoryId + `" data-vibrateTime="30" class="vibrate button button-fill button-large sound-3">В корзину за ` + item.price + ` ₽</button>

                                        </div>

                                    </div>

                                </div>

                            </div>

                        </div>

                    `,
                    backdrop: true,
                    swipeToClose: true,
                    value: 1,
                    on: {
                        open: function () {

                            if (component.restoraunt.schedule.length > 0) {

                                let schedule = JSON.parse(component.restoraunt.schedule);

                                let day = new Date().getDay();
                                let hours = new Date().getHours();

                                if ( schedule.workDays.indexOf( String(day) ) == -1 )  {

                                    sheet.$el.find('.add-to-cart').html('<div class="padding bg-color-light-gray">Извините но сегодня ресторан не работает, попробуйте завтра.</div>');

                                    return false;

                                }

                                if (schedule.workStartTime === '00' && schedule.workStopTime === '00') {

                                    return false;

                                }

                                schedule.workStartTime = schedule.workStartTime + ':00';
                                schedule.workStopTime = schedule.workStopTime + ':00';

                                let now = app.methods.getMinutesNow();

                                let start = app.methods.getMinutes(schedule.workStartTime);

                                let end = app.methods.getMinutes(schedule.workStopTime);

                                if (start > end) end += app.methods.getMinutes('24:00');

                                if ( (now > start) && (now < end) ) {

                                } else {

                                    sheet.$el.find('.add-to-cart').html('<div class="padding bg-color-light-gray">Извините но сейчас ресторан не работает, попробуйте в период с ' + schedule.workStartTime + ' до ' + schedule.workStopTime + '</div>');

                                }

                            }

                        },
                        opened: function (sheet) {

                            setTimeout(function () {

                                sheet.$el.find('.item-image').find('.overlay').addClass('show');

                            }, 100);

                            let stepper = app.stepper.create({
                                el: sheet.$el.find('.stepper'),
                                min: 1,
                                max: 100,
                                value: 1,
                                on: {
                                    change: function (stepper, value) {

                                        if (value === 1) {

                                            sheet.$el.find('.stepper').find('.stepper-button-minus').addClass('disabled');

                                        } else {

                                            sheet.$el.find('.stepper').find('.stepper-button-minus').removeClass('disabled');

                                        }

                                    }
                                }
                            });

                            sheet.$el.find('.button').on('click', function () {

                                let categoryId = $$(this).data('category');

                                let category = component.restoraunt.categories.find(function (category) {

                                    return category.id == categoryId;

                                });

                                let item = category.items.find(function (item) {

                                    return item.id == itemId;

                                });

                                app.methods.cart.add(item, stepper.getValue(), function () {

                                    sheet.close();

                                });

                            });

                        }
                    }
                });

                sheet.open();

            },
            loadRestoraunt: function (callback) {

                let component = this;
                let page = component.$el;

                let id = component.$router.currentRoute.params.id;

                setTimeout(function () {

                    component.showSkeleton = true;

                    component.$update();

                }, 300);

                app.request({
                   url: app.params.config.backend + '/api/restoraunt',
                   dataType: 'json',
                   data: {
                       id: id
                   },
                    success: function (response) {

                       component.restoraunt = response;

                       component.$update(function () {

                           if (callback) {

                               callback();

                           }

                       });

                    }
                });

            },
            checkInFavorites: function () {

                let component = this;
                let page = component.$el;

                app.request({
                    url: app.params.config.backend + '/api/check-restoraunt-in-favorites',
                    data: {
                        user: localStorage.user,
                        restoraunt: component.restoraunt.id
                    },
                    success: function (response) {

                        if (response === 'true') {

                            page.find('.favorite-button').addClass('active');

                            page.find('.favorite-button').find('.icon').html('bookmark_fill');

                        }

                    }
                });

            },
            scroll: async function () {

                let component = this;
                let page = component.$el;

                let scrollTop = page.find('.page-content').scrollTop();

                let categories = [];

                page.find('.category-title').each(function (i) {

                    let id = $$(this).data('id');
                    let offset = $$(this).offset().top + scrollTop - 200;

                    if (scrollTop >= offset) {

                        categories.push({
                            id: id,
                            offset: offset
                        });

                    }

                });

                if (categories.length > 0) {

                    let activeCategory = categories[categories.length - 1];

                    page.find('.categories').find('.button').removeClass('active');

                    page.find('.categories').find('.button').addClass('bg-color-light-gray text-color-black color-black');

                    page.find('.categories').find('.button[data-id="' + activeCategory.id + '"]').removeClass('bg-color-light-gray text-color-black color-black');

                    page.find('.categories').find('.button[data-id="' + activeCategory.id + '"]').addClass('active');

                    let scrollLeft = page.find('.navbar').find('.categories').scrollLeft();

                    let offsetLeft = page.find('.navbar').find('.button[data-id="' + activeCategory.id + '"]').offset().left + scrollLeft - 15;

                    if (page.find('.navbar').find('.button:first-child').data('id') === activeCategory.id) {

                        offsetLeft = + offsetLeft + 1;

                    }

                    page.find('.navbar').find('.categories').scrollLeft(offsetLeft, 500);

                    page.find('.page-content').find('.categories').scrollLeft(offsetLeft, 500);

                } else {

                    page.find('.categories').find('.button').removeClass('active');

                    page.find('.categories').find('.button').addClass('bg-color-light-gray text-color-black color-black');

                    page.find('.navbar').find('.categories').scrollLeft(0, 500);

                    page.find('.page-content').find('.categories').scrollLeft(0, 500);

                }

            }
        },
        on: {

            pageInit: function() {

                let component = this;
                let page = component.$el;

                component.loadRestoraunt(function () {

                    if (app.device.ios) {

                        app.lazy.create(page.find('.page-content'));

                    }

                    let searchbar = app.searchbar.create({
                        el: '.searchbar-items',
                        searchContainer: '.block-items-1',
                        searchGroup: '.block-items',
                        searchGroupTitle: '.category-title',
                        searchIn: '.item-title',
                        searchItem: '.item',
                        on: {
                            search(sb, query, previousQuery) {
                                
                                console.log(query, previousQuery);

                                page.find('.page-content').scrollTop(0);
                                
                                page.find('.block-items').each(function (i) {
                                   
                                    if ($$(this).find('.items').find('.item:not(.hidden-by-searchbar)').length > 0) {

                                        $$(this).find('.category-title').removeClass('hidden-by-searchbar');

                                    }
                                    
                                });

                            },
                            enable: function () {

                                page.find('.navbar').removeClass('subnavbar-show');

                            },
                            disable: function () {

                                page.find('.navbar').removeClass('navbar-large-collapsed');

                            }
                        }
                    });

                    component.checkInFavorites();

                    page.find('.favorite-button').on('click', function () {

                        if (app.params.user) {

                            if ($$(this).hasClass('active')) {

                                app.methods.favorites.removeRestoraunt(component.restoraunt.id);

                                $$(this).find('.icon').html('bookmark');

                                $$(this).removeClass('active');

                            } else {

                                app.methods.favorites.addRestoraunt(component.restoraunt.id);

                                $$(this).find('.icon').html('bookmark_fill');

                                $$(this).addClass('active');

                            }

                        } else {

                            let sheet = app.sheet.create({
                                content: `

                                    <div class="sheet-modal sheet-template-1">

                                        <div class="sheet-modal-inner">

                                            <div class="swipe-handler"></div>

                                            <div class="block">

                                                <div class="block-title block-title-medium text-align-center">Вы не авторизованы</div>

                                                <div class="margin text-color-gray text-align-center">Для получения всех возможностей приложения пожалуйста авторизуйтесь.</div>

                                            </div>

                                            <a href="#" onclick=$$('.toolbar-menu').find('a[href="#view-profile"]').click() class="button button-large bg-color-light-gray color-black button-ok sheet-close">Вход / Регистрация</a>

                                        </div>

                                    </div>

                                `,
                                backdrop: true,
                                swipeToClose: true,
                                on: {
                                    opened: function () {
                                        console.log('Sheet opened')
                                    }
                                }
                            });

                            sheet.open();

                        }

                    });

                    let category_id = component.$router.currentRoute.params.category_id;

                    if (category_id) {

                        setTimeout(function () {

                            page.find('.navbar').find('.button[data-id="' + category_id + '"]').click();

                        }, 100);

                    }

                    page.find('.categories').find('.button').on('click', function () {

                        let id = $$(this).data('id');

                        let scrollTop = page.find('.page-content').scrollTop();

                        let offsetTop = page.find('.category-title[data-id="' + id + '"]').offset().top  + scrollTop - 200;

                        page.find('.page-content').scrollTop(offsetTop, 300);

                    });

                    page.find('.navbar').find('.categories').on('scroll', function () {

                        let scrollLeft = $$(this).scrollLeft();

                        page.find('.page-content').find('.categories').scrollLeft(scrollLeft);

                    });

                    page.find('.page-content').on('scroll', function () {

                        let scrollTop = page.find('.page-content').scrollTop();

                        let categoriesOffset = page.find('.page-content').find('.categories').offset().top + page.find('.page-content').find('.categories').height() + 70;

                        if (scrollTop >= categoriesOffset) {

                            page.find('.navbar').addClass('subnavbar-show');

                        } else {

                            page.find('.navbar').removeClass('subnavbar-show');

                        }

                        window.clearTimeout(component.allowScrollTimeout);

                        component.allowScrollTimeout = setTimeout(function () {

                            component.scroll();

                        }, 100);

                    });

                });

            },
            pageBeforeOut: function () {

                let component = this;

                app.sheet.close();

                clearTimeout(component.allowScrollTimeout);

            }

        }

    }

</script>