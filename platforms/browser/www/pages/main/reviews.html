<template>

    <div class="page bg-color-white">

        <div class="navbar navbar-large">

            <div class="navbar-bg"></div>

            <div class="navbar-inner sliding">

                <div class="left">

                    <a href="#" class="link back">

                        <i class="icon icon-back"></i>
                        <span class="ios-only">Назад</span>

                    </a>

                </div>

                <div class="title">Отзывы "{{restoraunt.name}}"</div>

                <div class="title-large">

                    <div class="title-large-text">Отзывы "{{restoraunt.name}}"</div>

                </div>

            </div>

        </div>

        <div class="page-content infinite-scroll-content">

            {{#if reviews}}

                {{#js_if "this.reviews.length > 0"}}

                    {{#each reviews}}

                        <div class="card card-outline review-item">

                            <div></div>

                            <div class="card-header row">

                                <div class="col author-name text-color-gray"><i class="icon f7-icons text-color-primary star-icon">star_fill</i> {{rating}} из 5</div>

                                <div class="col author-name text-color-gray text-align-right">{{user.firstname}}</div>

                            </div>

                            <div class="card-content card-content-padding">{{text}}</div>

                            <div class="card-footer">

                                <div class="text-color-gray">{{created_at}}</div>

                            </div>

                        </div>

                    {{/each}}

                    {{#if loadMore}}

                        <div class="block text-align-center width-100">

                            <div class="preloader"></div>

                        </div>

                    {{/if}}

                {{else}}

                    <div class="block">По вашему запросу ничего не найдено.</div>

                {{/js_if}}

            {{else}}

                <div class="block text-align-center">

                    <div class="preloader"></div>

                </div>

            {{/if}}

        </div>

    </div>

</template>

<style scoped>

    {{this}} .review-item .card-content {
        word-break: break-all;
        overflow: hidden;
    }


    {{this}} .review-item .author-name {
                 font-size: 14px;
             }

    {{this}} .review-item .star-icon {
                 font-size: 18px;
             }

</style>

<script>

    return {

        data: function () {

            return {


            }

        },
        methods: {
            loadReviews: function (pageNum, callback) {

                let component = this;
                let page = component.$el;

                pageNum = Number(pageNum);

                component.loadMore = false;

                page.attr('data-page', pageNum);

                app.request({
                    url: app.params.config.backend + '/api/reviews',
                    data: {
                        restoraunt_id: component.restoraunt.id,
                        page: pageNum
                    },
                    dataType: 'json',
                    success: function (response) {

                        if (pageNum > 1) {

                            component.reviews = component.reviews.concat(response.data);

                        } else {

                            component.reviews = response.data;

                        }

                        component.loadMore = response.next_page_url;

                        component.$update(function () {

                            if (callback !== undefined) {

                                callback();

                            }

                        });

                    },
                    complete: function () {

                        component.loading = false;

                    }
                });

            }
        },
        on: {

            pageInit: function() {

                let component = this;
                let page = component.$el;

                component.loadReviews(1, function () {

                    page.find('.infinite-scroll-content').on('infinite', function () {

                        if (!component.loading && component.loadMore) {

                            component.loading = true;

                            let pageNum = Number(page.data('page')) + 1;

                            component.loadReviews(pageNum);

                        }
                    });

                });

            }

        }

    }

</script>